---
import { getCollection, type CollectionEntry } from 'astro:content';
import MainGridLayout from '@layouts/MainGridLayout.astro';
import AboutMe from '@components/about/AboutMe.astro';
import HeroProfileCard from '@components/hero/HeroProfileCard.astro';
import Section from '@components/common/Section.astro';
import CategoryTabs from '@components/esg/CategoryTabs.astro';
import KPICard from '@components/esg/KPICard.astro';
import TimelineCard from '@components/esg/TimelineCard.astro';

// 1. URLì—ì„œ í™œì„± ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
const activeCategory = (Astro.url.searchParams.get('category') as 'all' | 'E' | 'S' | 'G') || 'all';

// 2. ëª¨ë“  ESG ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const esgEntries = await getCollection('esg', ({ data }) => {
  return new Date(data.period.split(' ')[0]) <= new Date();
});

// 3. KPI ì¹´ë“œìš© ë°ì´í„° ì¤€ë¹„
const specialEmphasisSlugs = ['e1', 'e3', 'g1', 's3'];
const sortedForKpi = [...esgEntries].sort((a, b) => { // ì›ë³¸ ë°°ì—´ ìˆ˜ì •ì„ í”¼í•˜ê¸° ìœ„í•´ ë³µì‚¬ë³¸ ì‚¬ìš©
    if (a.data.year !== b.data.year) {
        return parseInt(b.data.year) - parseInt(a.data.year);
    }
    return a.slug.localeCompare(b.slug);
});

let highEmphasisCounter = 0;
const kpiItems = sortedForKpi.map(entry => {
  let emphasis: 'extra-high' | 'high' | 'normal' = 'normal';
  if (specialEmphasisSlugs.includes(entry.slug)) {
    emphasis = highEmphasisCounter < 2 ? 'extra-high' : 'high';
    highEmphasisCounter++;
  }
  return { ...entry.data, slug: entry.slug, emphasis };
});

// 4. íƒ€ì„ë¼ì¸ ì¹´ë“œìš© ë°ì´í„° ì¤€ë¹„ (ì¤‘ìš”: ëª¨ë“  ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ë„ë¡ í•„í„°ë§ ì œê±°)
const timelineItems = [...esgEntries] // ì›ë³¸ ë°°ì—´ ìˆ˜ì •ì„ í”¼í•˜ê¸° ìœ„í•´ ë³µì‚¬ë³¸ ì‚¬ìš©
  .sort((a, b) => parseInt(b.data.year) - parseInt(a.data.year))
  .map(item => ({
    ...item.data,
    id: item.id,
    slug: item.slug,
    description: item.body, // ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ì„ descriptionìœ¼ë¡œ ì‚¬ìš©
  }));


const pageTitle = "About | Jinmini";
const pageDescription = "ESG AI ì „ë¬¸ê°€ì´ì í’€ìŠ¤íƒ ê°œë°œì, ê¹€ì§„ì˜ ì†Œê°œ í˜ì´ì§€ì…ë‹ˆë‹¤. í™˜ê²½, ì‚¬íšŒ, ì§€ë°°êµ¬ì¡°(ESG) ì˜ì—­ì—ì„œì˜ ì „ë¬¸ì„±ê³¼ AI ê¸°ìˆ ì„ ê²°í•©í•˜ì—¬ ì§€ì†ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ì„ ë§Œë“­ë‹ˆë‹¤.";
---

<MainGridLayout title={pageTitle} description={pageDescription}>
  <Section size="wide">
    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="text-center mb-12 lg:mb-16">
      <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 dark:text-gray-100 mb-6">
        ğŸŒ± ESG ë„ë©”ì¸ ì§€ì‹ì— AI ê¸°ìˆ ì„ í™œìš©í•©ë‹ˆë‹¤
      </h1>
      <p class="text-lg lg:text-xl text-gray-600 dark:text-gray-400 leading-relaxed max-w-3xl mx-auto">
        ì§€ì†ê°€ëŠ¥í•œ ë¯¸ë˜ë¥¼ ìœ„í•œ <span class="text-blue-600 dark:text-blue-400 font-semibold">íƒ„ì†Œì¤‘ë¦½ ì†”ë£¨ì…˜</span>ì„ ì„¤ê³„í•˜ê³  ê°œë°œí•©ë‹ˆë‹¤.
        <br class="hidden lg:block">
        í™˜ê²½(E), ì‚¬íšŒ(S), ì§€ë°°êµ¬ì¡°(G) ì˜ì—­ì—ì„œ <span class="text-green-600 dark:text-green-400 font-semibold">ê¸°ìˆ ê³¼ ì§€ì†ê°€ëŠ¥ì„±ì˜ ì¡°í™”</span>ë¥¼ ì¶”êµ¬í•©ë‹ˆë‹¤.
      </p>
    </div>

    <!-- í”„ë¡œí•„ ì¹´ë“œì™€ AboutMeë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜ (ì»¨í…Œì´ë„ˆ ì¤‘ì•™ ì •ë ¬) -->
    <div class="mb-16">
      <div class="w-fit mx-auto flex flex-col lg:flex-row gap-8 lg:gap-12 items-center lg:items-start">
        <!-- ì™¼ìª½: í”„ë¡œí•„ ì¹´ë“œ -->
        <div class="w-full max-w-sm flex-shrink-0">
          <HeroProfileCard isAboutPage={true} />
        </div>
        
        <!-- ì˜¤ë¥¸ìª½: AboutMe -->
        <div class="w-full lg:max-w-2xl">
          <AboutMe />
        </div>
      </div>
    </div>
  
    <!-- ESG íƒ€ì„ë¼ì¸ ì„¹ì…˜ -->
    <div class="w-full mx-auto">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-4 flex items-center justify-center gap-3">
          <span class="text-4xl">ğŸŒŸ</span>
          ESG í™œë™ ì—°í˜
        </h2>
        <p class="text-gray-600 dark:text-gray-400 text-lg">
          í™˜ê²½(E), ì‚¬íšŒ(S), ì§€ë°°êµ¬ì¡°(G) ê° ì˜ì—­ì—ì„œì˜ ì „ë¬¸ì ì¸ í”„ë¡œì íŠ¸ì™€ ì„±ê³¼
        </p>
      </div>

      <CategoryTabs />

      <!-- ì¤‘ìš”: í•­ìƒ ë‘ ì»¨í…Œì´ë„ˆë¥¼ ëª¨ë‘ ë Œë”ë§í•˜ê³ , hidden í´ë˜ìŠ¤ë¡œ ì´ˆê¸° ê°€ì‹œì„± ì œì–´ -->
      <div id="esg-content-container">
        <div id="kpi-grid" class:list={["w-full max-w-3xl mx-auto", { "hidden": activeCategory !== 'all' }]}>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 lg:grid-rows-4 gap-4 md:gap-6 auto-rows-[240px] [grid-auto-flow:dense]">
            {kpiItems.slice(0, 12).map(item => (
              <KPICard item={item} />
            ))}
          </div>
        </div>

        <div id="timeline-view" class:list={["w-full justify-center", { "hidden": activeCategory === 'all' }]}>
          <div class="relative w-full max-w-3xl mx-auto">
            <!-- ë°˜ì‘í˜• ìˆ˜ì§ íƒ€ì„ë¼ì¸ -->
            <div class="absolute left-[32px] sm:left-[48px] lg:left-[66px] top-0 bottom-0 w-0.5 bg-slate-200 dark:bg-slate-700"></div>
            {timelineItems.map((item, index) => (
              <TimelineCard item={item} index={index} />
            ))}
          </div>
        </div>
      </div>
    </div>
  </Section>
</MainGridLayout>

<script>
  function initializeAboutPage() {
    const tabsContainer = document.getElementById('category-tabs');
    // about í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
    if (!tabsContainer) return;

    const kpiGrid = document.getElementById('kpi-grid');
    const timelineView = document.getElementById('timeline-view');
    const allTimelineCards = Array.from(document.querySelectorAll('.timeline-card')) as HTMLElement[];

    // ì´ë¯¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì„¤ì •ë˜ì—ˆë‹¤ë©´ ì¤‘ë³µ ë¶€ì°© ë°©ì§€
    if (tabsContainer.dataset.initialized === 'true') return;
    tabsContainer.dataset.initialized = 'true';

    function updateView(activeCategory) {
      // Update Tabs
      tabsContainer.querySelectorAll('button').forEach(button => {
        const isCurrent = button.dataset.category === activeCategory;
        button.setAttribute('aria-current', isCurrent ? 'page' : 'false');
        
        const activeClass = 'bg-slate-800 dark:bg-blue-600 text-white border-slate-800 dark:border-blue-600';
        const inactiveClass = 'border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-500 hover:bg-slate-50 dark:hover:bg-slate-600';

        if(isCurrent) {
            button.classList.add(...activeClass.split(' '));
            button.classList.remove(...inactiveClass.split(' '));
        } else {
            button.classList.add(...inactiveClass.split(' '));
            button.classList.remove(...activeClass.split(' '));
        }
      });

      // Update Content Visibility
      if (activeCategory === 'all') {
        kpiGrid?.classList.remove('hidden');
        timelineView?.classList.add('hidden');
      } else {
        kpiGrid?.classList.add('hidden');
        timelineView?.classList.remove('hidden');

        // Filter Timeline Cards
        allTimelineCards.forEach(card => {
          if (card.dataset.category === activeCategory) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });
      }
    }

    tabsContainer.addEventListener('click', (e) => {
      const target = (e.target as HTMLElement).closest('button');
      if (target) {
        e.preventDefault();
        const category = target.dataset.category;
        updateView(category);
        window.history.pushState(null, '', `?category=${category}`);
      }
    });

    document.getElementById('esg-content-container').addEventListener('click', (e) => {
      const kpiCard = (e.target as HTMLElement).closest('.kpi-card');
      if (kpiCard) {
        e.preventDefault();
        const category = kpiCard.dataset.targetCategory;
        const slug = kpiCard.dataset.targetSlug;
        
        updateView(category);
        window.history.pushState(null, '', `?category=${category}`);
        
        const elementToScroll = document.getElementById(`esg-item-${slug}`);
        if(elementToScroll) {
            elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });

    // Initial load
    const initialCategory = new URLSearchParams(window.location.search).get('category') || 'all';
    updateView(initialCategory);

    // Initial scroll for direct anchor links
    if(window.location.hash) {
      const elementToScroll = document.querySelector(window.location.hash);
      if(elementToScroll) {
          elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  document.addEventListener('astro:page-load', initializeAboutPage);
</script>


